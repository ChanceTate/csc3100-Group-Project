<!DOCTYPE html>
<html data-bs-theme="dark" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleCoop Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch/dist/simplex/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/lib/login.css">
</head>

<body class="bg-dark">
    <nav class="navbar navbar-expand-lg border-0 border-bottom border-primary" id="navTitleBar">
        <div class="container-fluid">
            <a class="navbar-brand">SwollenHippo Smart Coop</a>
        </div>
    </nav>

    <div class="d-flex justify-content-center align-items-center min-vh-100">
        <div class="card border-primary col-10 col-md-7 col-lg-5" id="divLogin" style="display: none">
            <div class="card-header">
                <h3 class="text-center">Login</h3>
            </div>
            <div class="card-body">
                <form>
                    <div class="form-group mt-4">
                        <label for="txtLoginEmail" class="form-label">Email</label>
                        <input id="txtLoginEmail" class="form-control" type="email" placeholder="johndoe@gmail.com">
                    </div>
                    <div class="form-group mt-4">
                        <label for="txtLoginPassword" class="form-label">Password</label>
                        <input id="txtLoginPassword" class="form-control" type="password" placeholder="Password">
                    </div>

                    <button class="col-12 btn btn-success mt-4" id="btnLogin" type="button">Login</button>
                    <div class="col-12 d-flex justify-content-center">
                        <a href="#" class="col-12 text-center btnToggle" data-card="Login">Unregistered? Click here to create an
                            account.</a>
                    </div>
                </form>
            </div>
        </div>

        <div class="card border-primary col-10 col-md-7 col-lg-5 my-4" id="divRegister" style="display:none;">
            <div class="card-header">
                <h3 class="text-center">Registration</h3>
            </div>
            <div class="card-body">
                <form>
                    <div class="d-flex flex-column flex-md-row justify-content-evenly align-items-center align-items-md-start">
                        <div class="col-10 col-md-5">
                            <div class="form-group mt-2">
                                <label for="txtFirstName" class="form-label">First Name</label>
                                <input id="txtFirstName" class="form-control" type="text" placeholder="John">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtLastName" class="form-label">Last Name</label>
                                <input id="txtLastName" class="form-control" type="text" placeholder="Doe">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtRegisterEmail" class="form-label">Email</label>
                                <input id="txtRegisterEmail" class="form-control" type="email" placeholder="johndoe@gmail.com">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtRegisterPassword" class="form-label">Password</label>
                                <input id="txtRegisterPassword" class="form-control" type="password" placeholder="Password">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtPhone" class="form-label">Phone Number</label>
                                <input id="txtPhone" class="form-control" type="text" placeholder="(999)999-9999">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtCoopID" class="form-label">Coop Registration ID</label>
                                <input id="txtCoopID" class="form-control" type="text" placeholder="1234">
                            </div>
                        </div>    
                        <div class="col-10 col-md-5">
                            <div class="form-group mt-2">                    
                                <label for="txtStreetAddress1" class="form-label">Street Address 1</label>
                                <input id="txtStreetAddress1" class="form-control" type="text" placeholder="123 Street Street">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtStreetAddress2" class="form-label">Street Address 2</label>
                                <input id="txtStreetAddress2" class="form-control" type="text" placeholder="Apt. 123">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtCity" class="form-label">City</label>
                                <input id="txtCity" class="form-control" type="text" placeholder="City">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtState" class="form-label">State</label>
                                <input id="txtState" class="form-control" type="text" placeholder="State">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtZip" class="form-label">ZIP Code</label>
                                <input id="txtZip" class="form-control" type="text" placeholder="Zip Code">
                            </div>
                        </div>
                    </div>

                    <button class="col-12 btn btn-success mt-4" id="btnRegister" type="button">Register</button>
                    <div class="col-12 d-flex justify-content-center">
                        <a href="#" class="col-12 text-center btnToggle" data-card="Register">Return to login</a>
                    </div>
                </form>
            </div>
        </div>

        <div class="card col-12 col-md-10 col-lg-8" style="display:none;" id="divDashboard">
            <div class="card-header">
                <h3 class="text-center">Dashboard</h3>
            </div>
            <div class="card-body">
                <button class="btn btn-info" id="btnColorMode">Toggle Dark Mode</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script lang="text/javascript">
        let strSessionID = "";
        
        $(document).ready(function () {
            if (sessionStorage.getItem("SessionID")) {
                strSessionID = sessionStorage.getItem("SessionID");
                
                $.ajax({
                    type: 'GET',
                    url: "http://www.simplecoop.swollenhippo.com/settings.php",
                    data: {
                        SessionID: strSessionID,
                        setting: 'colormode'
                    },
                    error: function(e) {
                        console.log(e);
                        if(sessionStorage.getItem('SessionID')){$("#divDashboard").slideToggle();}
                    },
                    success: function(result) {
                        console.log(result);
                        result = JSON.parse(result);

                        if (result != null) {
                            $('html').attr('data-bs-theme', result.Value);
                        }
                        
                        if(sessionStorage.getItem('SessionID')) {
                            $("#divDashboard").slideToggle();
                            $("#navTitleBar").slideUp();
                        }
                    }
                });
            } else {
                $("#divLogin").slideToggle();
            }
        });
        // Toggles login and register cards using the jQuery "is visible" tool
        $('.btnToggle').on('click', function () {
            if ($('#divLogin').is(':visible')) {
                $('#divLogin').slideToggle(function () {
                    $('#divRegister').slideToggle();
                });
            }
            else {
                $('#divRegister').slideToggle(function () {
                    $('#divLogin').slideToggle();
                });
            }
        });

        $('#btnLogin').on('click', function () {
            let txtEmail = $('#txtLoginEmail').val();
            let txtPassword = $('#txtLoginPassword').val();

            $.post("http://www.simplecoop.swollenhippo.com/sessions.php", {Email:txtEmail, Password:txtPassword}, function(result){
                result = JSON.parse(result);

                if (result.Outcome != undefined)
                {
                    Swal.fire({
                        title: "Oops!",
                        html: "<p>Invalid email or password!</p>",
                        icon: "error",
                    });

                    return;
                }

                sessionStorage.setItem("SessionID", result.SessionID);
                $('#divLogin').slideToggle(function () {
                    $('#divDashboard').slideToggle();
                    $("#navTitleBar").slideUp();
                });
            })
        });

        function checkSessionID()
        {
            $.getJSON("http://www.simplecoop.swollenhippo.com/sessions.php", { SessionID: strSessionID }, function(result){
                console.log(result);
                if (result.SessionID != sessionStorage.getItem("SessionID")) {
                    sessionStorage.removeItem("SessionID");
                }
            })
        }

        $('#btnRegister').on('click', function () {
            let txtFirstName = $('#txtFirstName').val();
            let txtLastName = $('#txtLastName').val();
            let txtEmail = $('#txtRegisterEmail').val();
            let txtPassword = $('#txtRegisterPassword').val();
            let txtStreetAddress1 = $('#txtStreetAddress1').val();
            let txtStreetAddress2 = $('#txtStreetAddress2').val();
            let txtCity = $('#txtCity').val();
            let txtState = $('#txtState').val();
            let txtZip = $('#txtZip').val();
            let txtPhone = $('#txtPhone').val();
            let txtCoopID = $('#txtCoopID').val();

            let blnError = false;
            let strErrorMessage = "";

            let regexEmail = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/g;
            if (!regexEmail.exec(txtEmail)) {
                let blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Email.</p>";
            }

            let regexPassword = /^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*\W)(?!.* ).{8,16}$/;
            if (!regexPassword.exec(txtPassword)) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Password must be 8-16 characters, including a lowercase and uppercase letter, a number, and a special character.</p>";
            }

            if (txtFirstName.length < 2){
                let blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid First Name.</p>";
            }

            if (txtLastName.length < 2){
                let blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Last Name.</p>";
            }

            if (txtStreetAddress1.length < 5){
                let blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Street Address.</p>";
            }

            // none for address 2, that is allowed to be blank

            if (txtCity.length < 2){
                let blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid City.</p>";
            }

            if (txtState.length < 2){
                let blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid State.</p>";
            }

            let regexZip = /\d{5}([ \-]\d{4})?/;
            if (!regexZip.exec(txtZip)){
                let blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid ZIP Code.</p>";
            }

            let regexPhoneNum = /^\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$/;
            if (!regexPhoneNum.exec(txtPhone)){
                let blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Phone Number.</p>";
            }

            // Assuming IDs are length 8, may change later!
            if (txtCoopID.length != 8){
                let blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Coop Registration ID, must be 8 digits.</p>";
            }

            if (blnError == true) {
                console.log(strErrorMessage);
                Swal.fire({
                    title: "Oops!",
                    html: strErrorMessage,
                    icon: "error",
                });
            } else {
                $.getJSON("https://simplecoop.swollenhippo.com/users.php", { Email: txtEmail }, function(result) {
                    if (result != null)
                    {
                        Swal.fire({
                            title: "Oops!",
                            html: "<p>Account with that email already exists.</p>",
                            icon: "error",
                        });

                        return;
                    }

                    $.post(
                    "https://simplecoop.swollenhippo.com/users.php",
                    {
                        Email: txtEmail,
                        Password: txtPassword,
                        FirstName: txtFirstName,
                        LastName: txtLastName,
                        CoopID: txtCoopID,
                    },
                    function(result) {
                        result = JSON.parse(result);
                        if (result.Error) {
                            Swal.fire({
                            title: "Oops!",
                            html: "<p>" + result.Error + "</p>",
                            icon: "error",
                            });
                        }
                    }
                    )
                    $.post(
                        "https://simplecoop.swollenhippo.com/useraddress.php",
                        {
                            Email: txtEmail,
                            Street1: txtStreetAddress1,
                            Street2: txtStreetAddress2,
                            City: txtCity,
                            State: txtState,
                            ZIP: txtZip,
                        },
                        function(result) {
                            result = JSON.parse(result);
                            if (result.Error) {
                                Swal.fire({
                                title: "Oops!",
                                html: "<p>" + result.Error + "</p>",
                                icon: "error",
                                });
                            }
                        }
                    )

                    $.post("http://www.simplecoop.swollenhippo.com/sessions.php", {Email:txtEmail, Password:txtPassword}, function(result){
                        result = JSON.parse(result);

                        if (result.Outcome != undefined)
                        {
                            Swal.fire({
                                title: "Oops!",
                                html: "<p>There was an issue while loggin you in, please try again!</p>",
                                icon: "error",
                            });

                            return;
                        }

                        sessionStorage.setItem("SessionID", result.SessionID);
                        $('#divRegister').slideToggle(function () {
                            $('#divDashboard').slideToggle();
                            $("#navTitleBar").slideUp();
                        });
                    })
                })
            }
        });

        $('#btnColorMode').on('click', function() {
            let mode = $('html').attr('data-bs-theme');
            if (mode == 'light') {
                $('html').attr('data-bs-theme', 'dark');
                mode = 'dark';
            } else {
                $('html').attr('data-bs-theme', 'light');
                mode = 'light';
            }

            $.ajax({
                type: 'DELETE',
                url: "http://www.simplecoop.swollenhippo.com/settings.php",
                data: {
                    SessionID: sessionStorage.getItem('SessionID'),
                    setting: 'colormode'
                },
                error: function(e) {
                    console.log(e);
                },
                success: function(result) {
                    console.log(result);
                    $.ajax({
                        type: 'POST',
                        url: "http://www.simplecoop.swollenhippo.com/settings.php",
                        data: {
                            SessionID: sessionStorage.getItem('SessionID'),
                            setting: "colormode",
                            value: mode
                        },
                        error: function(e) {
                            console.log(e);
                        },
                        success: function(result) {
                            console.log(result);
                        }
                    });
                }
            });

        });
    </script>
</body>

</html>
