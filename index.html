<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleCoop Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch/dist/journal/bootstrap.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/d7eaa0fcbe.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/lib/login.css">
    <script>
        let colormode = localStorage.getItem('colormode');
        if (colormode == 'dark') {
            document.getElementsByTagName('html')[0].setAttribute('data-bs-theme', 'dark');
        }
    </script>
</head>

<body class="vh-100 h-100 bg-gradient" style="background-repeat: no-repeat;">
    <!-- Navbar -->
    <nav class="navbar navbar-expand bg-primary" id="navTitleBar">
        <div class="container-fluid">
            <a class="navbar-brand text-light">SwollenHippo Smart Coop</a>
        </div>
        <button id="btnLogout" class="btn btn-info" style="display:none">Logout</button>
        <button type="button" class="btn border-0" id="btnColorMode" aria-label="Toggle Dark Mode">
            <i class="fa-solid fa-moon fs-4"></i>
            <i style="display: none" class="fa-solid fa-sun fs-4"></i>
        </button>
    </nav>
    <!-- Main Content -->
    <div class="d-flex justify-content-center align-items-center mt-5">
        <!-- Login -->
        <div class="card border-primary col-10 col-md-7 col-lg-5" id="divLogin" style="display: none">
            <div class="card-header bg-primary">
                <h3 class="text-center text-light">Login</h3>
            </div>
            <div class="card-body">
                <form>
                    <div class="form-group mt-4">
                        <label for="txtLoginEmail" class="form-label">Email</label>
                        <input id="txtLoginEmail" class="form-control" type="email" placeholder="johndoe@gmail.com">
                    </div>
                    <div class="form-group mt-4">
                        <label for="txtLoginPassword" class="form-label">Password</label>
                        <input id="txtLoginPassword" class="form-control" type="password" placeholder="Password">
                    </div>

                    <button class="col-12 btn btn-success mt-4" id="btnLogin" type="button">Login</button>
                    <div class="col-12 d-flex justify-content-center">
                        <a href="#" class="col-12 text-center btnToggle" data-card="Login">Unregistered? Click here to
                            create an
                            account.</a>
                    </div>
                </form>
            </div>
        </div>
        <!-- Registration -->
        <div class="card border-primary col-10 col-md-7 col-lg-5 my-4" id="divRegister" style="display:none">
            <div class="card-header bg-primary">
                <h3 class="text-center text-light">Registration</h3>
            </div>
            <div class="card-body">
                <form>
                    <div
                        class="d-flex flex-column flex-md-row justify-content-evenly align-items-center align-items-md-start">
                        <div class="col-10 col-md-5">
                            <div class="form-group mt-2">
                                <label for="txtFirstName" class="form-label">First Name</label>
                                <input id="txtFirstName" class="form-control" type="text" placeholder="John">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtLastName" class="form-label">Last Name</label>
                                <input id="txtLastName" class="form-control" type="text" placeholder="Doe">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtRegisterEmail" class="form-label">Email</label>
                                <input id="txtRegisterEmail" class="form-control" type="email"
                                    placeholder="johndoe@gmail.com">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtRegisterPassword" class="form-label">Password</label>
                                <input id="txtRegisterPassword" class="form-control" type="password"
                                    placeholder="Password">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtPhone" class="form-label">Phone Number</label>
                                <input id="txtPhone" class="form-control" type="text" placeholder="(999)999-9999">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtCoopID" class="form-label">Coop Registration ID</label>
                                <input id="txtCoopID" class="form-control" type="text" placeholder="1234">
                            </div>
                        </div>
                        <div class="col-10 col-md-5">
                            <div class="form-group mt-2">
                                <label for="txtStreetAddress1" class="form-label">Street Address 1</label>
                                <input id="txtStreetAddress1" class="form-control" type="text"
                                    placeholder="123 Street Street">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtStreetAddress2" class="form-label">Street Address 2</label>
                                <input id="txtStreetAddress2" class="form-control" type="text" placeholder="Apt. 123">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtCity" class="form-label">City</label>
                                <input id="txtCity" class="form-control" type="text" placeholder="City">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtState" class="form-label">State</label>
                                <input id="txtState" class="form-control" type="text" placeholder="State">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtZip" class="form-label">ZIP Code</label>
                                <input id="txtZip" class="form-control" type="text" placeholder="Zip Code">
                            </div>
                            <div class="form-group mt-2">
                                <label for="btnCoopIDInfo" class="form-label"><i
                                        class="fa-solid fa-question fs-5"></i></label>
                                <button class="btn btn-info form-control" id="btnCoopIDInfo" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapseCoopID"
                                    area-label="Expandable CoopID Explanation">
                                    About CoopID
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="collapse mt-3" id="collapseCoopID">
                        <div class="col-12 d-flex justify-content-center">
                            <div class="card col-11">
                                <div class="card-body">
                                    The CoopID is a unique identifier associated with your SwollenHippo Smart Coop,
                                    located on a quick-start slip found inside the box your coop came in. If you cannot
                                    find it
                                    or it has been lost, contact our support line!
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="col-12 btn btn-success mt-4" id="btnRegister" type="button">Register</button>
                    <div class="col-12 d-flex justify-content-center">
                        <a href="#" class="col-12 text-center btnToggle" data-card="Register">Return to login</a>
                    </div>
                </form>
            </div>
        </div>
        <!-- DashBoard -->
        <div class="col-12 vh-100 px-5 pb-5" style="display:none" id="divDashboard">
            <div class="d-flex flex-column flex-md-row justify-content-center align-items-start">
                <div class="card h-50 border-primary col-xl-5 col-lg-6 col-12 mx-2 mt-3">
                    <div class="card-header bg-primary">
                        <h3 class="text-center text-light">Weather</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between px-2 mt-2">
                            <div>
                                <p id="weatherCondition">Loading...</p>
                            </div>
                            <div class="d-flex">
                                <hr class="vr me-4">
                                </hr>
                                <div>
                                    <div class="mb-2">
                                        <p id="weatherLocation">Cookeville</p>
                                        <p id="weatherDate">Loading...</p>
                                    </div>
                                    <p id="weatherTemperature">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onclick="updateWeather()">Update Weather</button>
                </div>
                <div class="card h-50 border-primary col-xl-5 col-lg-6 col-12 mx-2 mt-3">
                    <div class="card-header bg-primary">
                        <h3 class="text-center text-light">Egg Counter</h3>
                    </div>
                    <div class="card-body">
                        <div>
                            <div class="input-group mb-4 d-flex justify-content-center">
                                <input class="rounded-start col-lg-3 col-md-2 col-sm-2 col-5" id="numEggs" type="number"
                                    aria-label="Number of eggs to log">
                                <button id="btnEggs" class="btn btn-primary">Log Eggs</button>
                            </div>
                            <div class="d-flex justify-content-center align-items-center">
                                <p class="d-sm-block d-none my-auto">Total eggs logged in&nbsp;</p>
                                <p class="my-auto">last</p>
                                <input id="numEggsFilter" type="number" class="mx-2 col-2 rounded-3"
                                    aria-label="Eggs logged in last blank days" onchange="filterEggs()">
                                <p class="my-auto">days:</p>
                                <h3 id="txtEggsTotal" class="ms-2 my-auto">0</h3>
                            </div>
                        </div>
                    </div>
                    <!-- Buttons -->
                    <div class="card-footer bg-transparent border-0">
                        <button id="btnLogObservation" class="btn btn-primary w-100">Log Observation</button>
                        <select id="viewOption" class="form-select w-100">
                            <option value="table">View Data as Table</option>
                            <option value="graph">View Data as Graph</option>
                        </select>
                    </div>
                </div>
            </div>
        
            <!-- Table -->
            <div class="card-body" style="display:none;" id="divTable">
                <h3 class="text-center mb-4">Observations</h3>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Observation Date (YYYY-MM-DD)</th>
                            <th>Temperature (F)</th>
                            <th>Humidity %</th>
                        </tr>
                    </thead>
                    <tbody id="observationTableBody">
                        <!-- Observation data will be here-->
                    </tbody>
                </table>
            </div>
            <!-- Graph -->
            <div class="card-body" style="display:none;" id="divGraph">
                <canvas id="observationGraph"></canvas>
            </div>
        </div>

    </div>
    </div>
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script lang="text/javascript">

        // Just here for now to delete users to test registration. Just uncomment this call
        // and pass the email you want to delete as a string and refresh

        // deleteUser('');

        function deleteUser(strEmail){
            $.ajax({
                type: 'DELETE',
                url: "http://www.simplecoop.swollenhippo.com/users.php",
                data: {
                    Email: strEmail
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {
                    result = JSON.parse(result);
                    console.log(result);
                }
            });
        }

        // Weather widget functionality
        function updateWeather() {
            // Get random weather data
            const temperature = getRandomTemperature().toFixed(1); // Round to one decimal
            const humidity = getRandomHumidity().toFixed(1);
            const observationDatetime = getRandomObservationDatetime();
            const date = new Date(observationDatetime); // Convert to Date object
            const weatherConditions = ["Sunny", "Raining", "Partly Cloudy"];

            // Update the widget elements
            const randomIndex = Math.floor(Math.random() * weatherConditions.length);
            document.getElementById("weatherCondition").textContent = weatherConditions[randomIndex];
            document.getElementById("weatherDate").textContent = date.toLocaleDateString();
            document.getElementById("weatherTemperature").textContent = temperature + "°F";
        }

        // Updates Session's LastUsedDateTime
        function updateSession() {
            $.ajax({
                type: 'PUT',
                url: "http://www.simplecoop.swollenhippo.com/sessions.php",
                data: { SessionID: sessionStorage.getItem("SessionID") },
                error: function (e) {
                    console.log(e);
                },
            });
        }

        function getSettings() {
            if (!sessionStorage.getItem("SessionID")) {
                console.log("SessionID invalid or does not exist, settings could not be found.");
                return;
            }

            $.ajax({
                type: 'GET',
                url: "http://www.simplecoop.swollenhippo.com/settings.php",
                data: {
                    SessionID: sessionStorage.getItem("SessionID"),
                    setting: 'colormode'
                },
                error: function (e) {
                    console.log(e);
                    updateSession();
                },
                success: function (result) {
                    result = JSON.parse(result);

                    if (result != null) {
                        let strMode = result.Value;
                        if (strMode == 'dark') {
                            $('html').attr('data-bs-theme', 'dark');
                            $("#btnColorMode").attr('aria-label', 'Toggle Light Mode');
                            localStorage.setItem('colormode', 'dark');
                            $(".fa-moon").hide();
                            $(".fa-sun").show();
                        } else {
                            $('html').attr('data-bs-theme', 'light');
                            $("#btnColorMode").attr('aria-label', 'Toggle Dark Mode');
                            localStorage.setItem('colormode', 'light');
                            $(".fa-moon").show();
                            $(".fa-sun").hide();
                        }
                    }
                }
            });
        }

        function setColorMode(strMode) {
            if (strMode != 'light' && strMode != 'dark') {
                console.log("Invalid color mode string");
                return;
            }

            if (sessionStorage.getItem('SessionID')) {
                $.ajax({
                    type: 'DELETE',
                    url: "http://www.simplecoop.swollenhippo.com/settings.php",
                    data: {
                        SessionID: sessionStorage.getItem('SessionID'),
                        setting: 'colormode'
                    },
                    error: function (e) {
                        console.log(e);
                    },
                    success: function (result) {
                        result = JSON.parse(result);
                        
                        $.ajax({
                            type: 'POST',
                            url: "http://www.simplecoop.swollenhippo.com/settings.php",
                            data: {
                                SessionID: sessionStorage.getItem('SessionID'),
                                setting: "colormode",
                                value: strMode
                            },
                            error: function (e) {
                                console.log(e);
                            },
                            success: function (result) {
                                result = JSON.parse(result);
                                
                                localStorage.setItem('colormode', strMode);
                                $("#btnColorMode").prop('disabled', false);
                            }
                        });
                    }
                });
            } else {
                localStorage.setItem('colormode', strMode);
                $("#btnColorMode").prop('disabled', false);
            }
        }

        function calculateEggs(strEmail) {
            $.ajax({
                type: 'GET',
                url: "http://www.simplecoop.swollenhippo.com/users.php",
                data: {
                    Email: strEmail
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {   
                    result = JSON.parse(result);

                    if (result.EstablishedDate) {
                        let dtCreationDate = new Date(result.EstablishedDate);
                        intDaysSinceAccountCreation = Math.ceil((new Date() - dtCreationDate) / (1000 * 60 * 60 * 24));
                        updateSession();
                        $("#numEggsFilter").val(intDaysSinceAccountCreation);
                        filterEggs();
                    } else {
                        console.log("Egg data could not be found.");
                    }
                }
            });
        }

        function filterEggs() {
            let intDays = $('#numEggsFilter').val();
            $.ajax({
                type: 'GET',
                url: "http://www.simplecoop.swollenhippo.com/eggs.php",
                data: {
                    SessionID: sessionStorage.getItem('SessionID'),
                    days: intDays
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) { 
                    result = JSON.parse(result);

                    let intTotalEggs = 0;
                    result.forEach(log => {
                        intTotalEggs += log.Harvested;
                    });
                    $('#txtEggsTotal').text(intTotalEggs);
                }
            });

        }

        $(document).ready(function () {
            // Call the function to log environment observations
            logEnvironmentObservations();
            // Call function to initially hide chart and show table
            $('#divGraph').hide();
            $('#divTable').show();

            let intDaysSinceAccountCreation = 0;
            let strEmail = "";
            // Checks if there is anything in sessionStorage
            if (sessionStorage.getItem("SessionID")) {
                $.getJSON("http://www.simplecoop.swollenhippo.com/sessions.php", { SessionID: sessionStorage.getItem("SessionID") }, function (result) {                    
                    if (result.SessionID != sessionStorage.getItem("SessionID")) {
                        sessionStorage.removeItem("SessionID");
                    }

                    strEmail = result.Email;

                    if (!strEmail) {
                        console.log("Could not find user email from session ID");
                        $("#divLogin").slideToggle();
                        return;
                    }

                    if (sessionStorage.getItem("SessionID")) {
                        getSettings();
                        calculateEggs(strEmail);
                        logEnvironmentObservations();

                        $('#btnLogout').show();
                        $("#divDashboard").slideToggle();
                    } else {
                        $("#divLogin").slideToggle();
                        if (localStorage.getItem('colormode') == 'dark') {
                            $("#btnColorMode").attr('aria-label', 'Toggle Light Mode');
                            $(".fa-moon").hide();
                            $(".fa-sun").show();
                        }
                    }
                });
            } else {
                $("#divLogin").slideToggle();
                if (localStorage.getItem('colormode') == 'dark') {
                    $("#btnColorMode").attr('aria-label', 'Toggle Light Mode');
                    $(".fa-moon").hide();
                    $(".fa-sun").show();
                }
            }
        });

        // Toggles login and register cards using the jQuery "is visible" tool
        $('.btnToggle').on('click', function () {
            if ($('#divLogin').is(':visible')) {
                $('#divLogin').slideToggle(function () {
                    $('#divRegister').slideToggle();
                });
            }
            else {
                $('#divRegister').slideToggle(function () {
                    $('#divLogin').slideToggle();
                });
            }
        });

        // Logout button functionality
        $('#btnLogout').on('click', function () {
            $.ajax({
                url: 'http://www.thesimplehomestead.com/simpletime/sessions.php',
                type: 'DELETE',
                data: { SessionID: sessionStorage.getItem('SessionID') },
                success: function (result) {
                    sessionStorage.removeItem('SessionID');

                    $('#divDashboard').slideUp(function () {
                        $('#btnLogout').hide();
                        $('#divLogin').slideDown();
                    })
                }
            });
        })

        // Login button functionality
        $('#btnLogin').on('click', function () {
            let strEmail = $('#txtLoginEmail').val();
            let strPassword = $('#txtLoginPassword').val();
            let intDaysSinceAccountCreation = 0;

            $.post("http://www.simplecoop.swollenhippo.com/sessions.php", { Email: strEmail, Password: strPassword }, function (result) {
                result = JSON.parse(result);

                if (result.Outcome != undefined) {
                    Swal.fire({
                        title: "Oops!",
                        html: "<p>Invalid email or password!</p>",
                        icon: "error",
                    });

                    return;
                }
                sessionStorage.setItem("SessionID", result.SessionID);

                getSettings();
                calculateEggs(strEmail);
                logEnvironmentObservations();

                $('#txtLoginEmail').val('');
                $('#txtLoginPassword').val('');
                $('#divLogin').slideToggle(function () {
                    $('#btnLogout').show();
                    $('#divDashboard').slideToggle();
                });

            })
        });

        // Register button functionality
        $('#btnRegister').on('click', function () {
            let strFirstName = $('#txtFirstName').val();
            let strLastName = $('#txtLastName').val();
            let strEmail = $('#txtRegisterEmail').val();
            let strPassword = $('#txtRegisterPassword').val();
            let strStreetAddress1 = $('#txtStreetAddress1').val();
            let strStreetAddress2 = $('#txtStreetAddress2').val();
            let strCity = $('#txtCity').val();
            let strState = $('#txtState').val();
            let strZip = $('#txtZip').val();
            let strPhone = $('#txtPhone').val();
            let strCoopID = $('#txtCoopID').val();

            let blnError = false;
            let strErrorMessage = "";

            let regexEmail = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/g;
            if (!regexEmail.exec(strEmail)) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Email.</p>";
            }

            let regexPassword = /^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*\W)(?!.* ).{8,16}$/;
            if (!regexPassword.exec(strPassword)) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Password must be 8-16 characters, including a lowercase and uppercase letter, a number, and a special character.</p>";
            }

            if (strFirstName.length < 2) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid First Name.</p>";
            }

            if (strLastName.length < 2) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Last Name.</p>";
            }

            if (strStreetAddress1.length < 5) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Street Address.</p>";
            }

            // none for address 2, that is allowed to be blank

            if (strCity.length < 2) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid City.</p>";
            }

            if (strState.length < 2) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid State.</p>";
            }

            let regexZip = /\d{5}([ \-]\d{4})?/;
            if (!regexZip.exec(strZip)) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid ZIP Code.</p>";
            }

            let regexPhoneNum = /^\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$/;
            if (!regexPhoneNum.exec(strPhone)) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Phone Number.</p>";
            }

            // Assuming IDs are length 8, may change later!
            if (strCoopID !== 'PTEYA3J6') {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Coop ID should be PTEYA3J6</p>";
            }

            if (blnError == true) {
                console.log(strErrorMessage);
                Swal.fire({
                    title: "Oops!",
                    html: strErrorMessage,
                    icon: "error",
                });
            } else {
                $.getJSON("http://simplecoop.swollenhippo.com/users.php", { Email: strEmail }, function (result) {
                    if (result != null) {
                        Swal.fire({
                            title: "Oops!",
                            html: "<p>Account with that email already exists.</p>",
                            icon: "error",
                        });

                        return;
                    }

                    $.post(
                        "http://simplecoop.swollenhippo.com/users.php",
                        {
                            Email: strEmail,
                            Password: strPassword,
                            FirstName: strFirstName,
                            LastName: strLastName,
                            CoopID: strCoopID,
                        },
                        function (result) {
                            result = JSON.parse(result);
                            
                            if (result.Error) {
                                Swal.fire({
                                    title: "Oops!",
                                    html: "<p>" + result.Error + "</p>",
                                    icon: "error",
                                });
                            }
                        }
                    )

                    $.post(
                        "http://simplecoop.swollenhippo.com/useraddress.php",
                        {
                            Email: strEmail,
                            Street1: strStreetAddress1,
                            Street2: strStreetAddress2,
                            City: strCity,
                            State: strState,
                            ZIP: strZip,
                        },
                        function (result) {
                            result = JSON.parse(result);
                            
                            if (result.Error) {
                                Swal.fire({
                                    title: "Oops!",
                                    html: "<p>" + result.Error + "</p>",
                                    icon: "error",
                                });
                            }
                        }
                    )

                    $.post("http://www.simplecoop.swollenhippo.com/sessions.php", { Email: strEmail, Password: strPassword }, function (result) {
                        result = JSON.parse(result);                       

                        if (result.Outcome != undefined) {
                            Swal.fire({
                                title: "Oops!",
                                html: "<p>There was an issue while loggin you in, please try again!</p>",
                                icon: "error",
                            });

                            return;
                        }

                        $('#txtFirstName').val('');
                        $('#txtLastName').val('');
                        $('#txtRegisterEmail').val('');
                        $('#txtRegisterPassword').val('');
                        $('#txtStreetAddress1').val('');
                        $('#txtStreetAddress2').val('');
                        $('#txtCity').val('');
                        $('#txtState').val('');
                        $('#txtZip').val('');
                        $('#txtPhone').val('');
                        $('#txtCoopID').val('');

                        sessionStorage.setItem("SessionID", result.SessionID);
                        setColorMode($('html').attr('data-bs-theme'));

                        logEnvironmentObservations();

                        $('#divRegister').slideToggle(function () {
                            $('#btnLogout').show();
                            $('#divDashboard').slideToggle();
                        });
                    })
                })
            }
        });

        // Dark mode toggle
        $('#btnColorMode').on('click', function () {
            $("#btnColorMode").prop('disabled', true);
            let strMode = $('html').attr('data-bs-theme');
            if (strMode == 'light') {
                $('html').attr('data-bs-theme', 'dark');
                $("#btnColorMode").attr('aria-label', 'Toggle Light Mode');
                $(".fa-moon").hide();
                $(".fa-sun").show();
                strMode = 'dark';
            } else {
                $('html').attr('data-bs-theme', 'light');
                $("#btnColorMode").attr('aria-label', 'Toggle Dark Mode');
                $(".fa-moon").show();
                $(".fa-sun").hide();
                strMode = 'light';
            }

            setColorMode(strMode);
        });

        // Log eggs
        $('#btnEggs').on('click', function () {
            let intEggs = $('#numEggs').val();
            $.ajax({
                type: 'POST',
                url: "http://www.simplecoop.swollenhippo.com/eggs.php",
                data: {
                    SessionID: sessionStorage.getItem('SessionID'),
                    eggs: intEggs,
                    observationDateTime: new Date().toISOString()
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {
                    result = JSON.parse(result);
                    
                    filterEggs();
                }
            });

        });

        function getRandomObservationDatetime() {
            // Get the current date
            var currentDate = new Date();     // Generate a random number of days between 0 and 100
            var randomDays = Math.floor(Math.random() * 101);     // Calculate the random date within the specified range
            var randomDate = new Date(currentDate);
            randomDate.setDate(currentDate.getDate() - randomDays);     // Format the date in ISO string format
            var observationDatetime = randomDate.toISOString(); return observationDatetime;
        }

        // Function to generate a random observation datetime in the format YYYY-MM-DD
        function getFormattedObservationDatetime() {
            var currentDate = new Date();
            var randomDays = Math.floor(Math.random() * 101);
            var randomDate = new Date(currentDate);
            randomDate.setDate(currentDate.getDate() - randomDays);

            var randomHour = Math.floor(Math.random() * 24);
            var randomMinute = Math.floor(Math.random() * 60);
            var randomSecond = Math.floor(Math.random() * 60);

            randomDate.setHours(randomHour, randomMinute, randomSecond);

            // Format date as YYYY-MM-DD
            var formattedDate = randomDate.toISOString().split('T')[0];

            // Format time as HH:MM
            var formattedTime = randomDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            return formattedDate + ' T ' + formattedTime;
        }

        // Function to generate a random temperature
        function getRandomTemperature() {
            return Math.random() * (90 - 42) + 42;
        }

        // Function to generate a random humidity
        function getRandomHumidity() {
            return Math.random() * (98 - 30) + 30;
        }

        function logEnvironmentObservations() {
            let observations = []; // create an array to store observations for sorting later

            for (let i = 0; i < 10; i++) {
                const observationDatetime = getFormattedObservationDatetime();
                const temperature = getRandomTemperature();
                const humidity = getRandomHumidity();

                observations.push({
                    observationDatetime: observationDatetime,
                    temperature: temperature,
                    humidity: humidity
                });
            }

            // Sort the random generated dates so that the Table is in order by date
            observations.sort((a, b) => {
                if (a.observationDatetime < b.observationDatetime) return 1;
                if (a.observationDatetime > b.observationDatetime) return -1;
                return 0;
            });

            // Append sorted observations to the table
            observations.forEach(observation => {
                $('#observationTableBody').append(
                    `<tr>
                        <td>${observation.observationDatetime}</td>
                        <td>${observation.temperature.toFixed(2)}</td>
                        <td>${observation.humidity.toFixed(2)}</td>
                    </tr>`
                );

                const requestData = {
                    SessionID: sessionStorage.getItem('SessionID'),
                    temperature: observation.temperature,
                    observationDateTime: observation.observationDatetime,
                    humidity: observation.humidity
                };

                $.post('http://simplecoop.swollenhippo.com/environment.php', requestData, function (result) {
                    result = JSON.parse(result);                   
                });
            });
        }

        let myGraph;

        $('#btnLogObservation').on('click', function () {
            var currentDate = new Date();

            // Format date and time into YYYY-MM-DD
            var formattedDate = currentDate.toISOString().split('T')[0];
            var formattedTime = currentDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            var observationDateTime = formattedDate + ' T ' + formattedTime;

            var temperature = getRandomTemperature().toFixed(2);
            var humidity = getRandomHumidity().toFixed(2);

            // Append the observation data to the top row of the table
            $('#observationTableBody').prepend(
                `<tr>
                    <td>${observationDateTime}</td>
                    <td>${temperature}</td>
                    <td>${humidity}</td>
                </tr>`
            );

            generateGraph();
            
        });

        // Function to switch between viewing data as table or graph
        $('#viewOption').change(function () {
            var selectedOption = $(this).val();
            if (selectedOption === 'table') {
                $('#divTable').show();
                $('#divGraph').hide();
            } else if (selectedOption === 'graph') {
                $('#divTable').hide();
                $('#divGraph').show();

                generateGraph();
            }
        });

        // Generate Graph
        function generateGraph() {
            // Destroy the current graph and then refil it witht the updated table to update the graph
            if (myGraph) {
                myGraph.destroy();
            }

            // Get all needed data from the table
            var observationRows = $('#observationTableBody tr');
            var observationDates = [];
            var temperatures = [];
            var humidities = [];

            observationRows.each(function () {
                var observationDatetime = $(this).find('td:first').text();
                var temperature = parseFloat($(this).find('td:nth-child(2)').text());
                var humidity = parseFloat($(this).find('td:nth-child(3)').text());
                observationDates.push(observationDatetime);
                temperatures.push(temperature);
                humidities.push(humidity);
            });

            // Reverse the arrays to display the most recent data on the right
            observationDates.reverse();
            temperatures.reverse();
            humidities.reverse();

            var ctx = document.getElementById('observationGraph').getContext('2d');
            myGraph = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: observationDates,
                    datasets: [{
                        label: 'Temperature (F)',
                        data: temperatures,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Humidity (%)',
                        data: humidities,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        }
    </script>
</body>

</html>