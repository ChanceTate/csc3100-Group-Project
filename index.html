<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleCoop Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch/dist/journal/bootstrap.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/d7eaa0fcbe.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.1/css/dataTables.dataTables.min.css">
    <link rel="stylesheet" href="css/lib/index.css">
    <script>
        let colormode = localStorage.getItem('colormode');
        if (colormode == 'dark') {
            document.getElementsByTagName('html')[0].setAttribute('data-bs-theme', 'dark');
        }
    </script>
</head>

<body class="bg-gradient" style="background-repeat: no-repeat; min-height: 100vh">
    <!-- Navbar -->
    <nav class="navbar navbar-expand bg-primary" id="navTitleBar">
        <div class="container-fluid">
            <a class="navbar-brand text-light">SwollenHippo Smart Coop</a>
        </div>
        <button id="btnLogout" class="btn btn-info" style="display:none">Logout</button>
        <button id="btnOpenSettings" class="btn btn-primary">Settings</button>
    </nav>
    <!-- Main Content -->
    <div class="d-flex justify-content-center align-items-center py-5 mx-4">
        <!-- Login -->
        <div class="card border-primary col-10 col-md-7 col-lg-5" id="divLogin" style="display: none">
            <div class="card-header bg-primary">
                <h3 class="text-center text-light">Login</h3>
            </div>
            <div class="card-body">
                <form>
                    <div class="form-group mt-4">
                        <label for="txtLoginEmail" class="form-label">Email</label>
                        <input id="txtLoginEmail" class="form-control" type="email" placeholder="johndoe@gmail.com">
                    </div>
                    <div class="form-group mt-4">
                        <label for="txtLoginPassword" class="form-label">Password</label>
                        <input id="txtLoginPassword" class="form-control" type="password" placeholder="Password">
                    </div>

                    <button class="col-12 btn btn-success mt-4" id="btnLogin" type="button">Login</button>
                    <div class="col-12 d-flex justify-content-center">
                        <a href="#" class="col-12 text-center btnToggle" data-card="Login">Unregistered? Click here to
                            create an
                            account.</a>
                    </div>
                </form>
            </div>
        </div>
        <!-- Registration -->
        <div class="card border-primary col-10 col-md-7 col-lg-5" id="divRegister" style="display:none">
            <div class="card-header bg-primary">
                <h3 class="text-center text-light">Registration</h3>
            </div>
            <div class="card-body">
                <form>
                    <div
                        class="d-flex flex-column flex-md-row justify-content-evenly align-items-center align-items-md-start">
                        <div class="col-10 col-md-5">
                            <div class="form-group mt-2">
                                <label for="txtFirstName" class="form-label">First Name</label>
                                <input id="txtFirstName" class="form-control" type="text" placeholder="John">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtLastName" class="form-label">Last Name</label>
                                <input id="txtLastName" class="form-control" type="text" placeholder="Doe">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtRegisterEmail" class="form-label">Email</label>
                                <input id="txtRegisterEmail" class="form-control" type="email"
                                    placeholder="johndoe@gmail.com">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtRegisterPassword" class="form-label">Password</label>
                                <input id="txtRegisterPassword" class="form-control" type="password"
                                    placeholder="Password">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtPhone" class="form-label">Phone Number</label>
                                <input id="txtPhone" class="form-control" type="text" placeholder="(999)999-9999">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtCoopID" class="form-label">Coop Registration ID</label>
                                <input id="txtCoopID" class="form-control" type="text" placeholder="1234">
                            </div>
                        </div>
                        <div class="col-10 col-md-5">
                            <div class="form-group mt-2">
                                <label for="txtStreetAddress1" class="form-label">Street Address 1</label>
                                <input id="txtStreetAddress1" class="form-control" type="text"
                                    placeholder="123 Street Street">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtStreetAddress2" class="form-label">Street Address 2</label>
                                <input id="txtStreetAddress2" class="form-control" type="text" placeholder="Apt. 123">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtCity" class="form-label">City</label>
                                <input id="txtCity" class="form-control" type="text" placeholder="City">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtState" class="form-label">State</label>
                                <input id="txtState" class="form-control" type="text" placeholder="State">
                            </div>
                            <div class="form-group mt-2">
                                <label for="txtZip" class="form-label">ZIP Code</label>
                                <input id="txtZip" class="form-control" type="text" placeholder="Zip Code">
                            </div>
                            <div class="form-group mt-2">
                                <label for="btnCoopIDInfo" class="form-label"><i
                                        class="fa-solid fa-question fs-5"></i></label>
                                <button class="btn btn-info form-control" id="btnCoopIDInfo" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapseCoopID"
                                    area-label="Expandable CoopID Explanation">
                                    About CoopID
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="collapse mt-3" id="collapseCoopID">
                        <div class="col-12 d-flex justify-content-center">
                            <div class="card col-11">
                                <div class="card-body">
                                    The CoopID is a unique identifier associated with your SwollenHippo Smart Coop,
                                    located on a quick-start slip found inside the box your coop came in. If you cannot
                                    find it
                                    or it has been lost, contact our support line!
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="col-12 btn btn-success mt-4" id="btnRegister" type="button">Register</button>
                    <div class="col-12 d-flex justify-content-center">
                        <a href="#" class="col-12 text-center btnToggle" data-card="Register">Return to login</a>
                    </div>
                </form>
            </div>
        </div>
       <!-- Settings Dashboard -->
        <div id="settingsDashboard" class="settings-dashboard" style="display: none;">
            <button id="btnCloseSettings" class="btn-close btn-close-grey" aria-label="Close"></button>
            <h3 class="text-center">Settings</h3>
            <div class="settings-widget">
                <!-- Mode Control Card -->
                <div class="card border-primary col-12 mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Mode Control</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="darkModeToggle" checked>
                                    <label class="form-check-label" for="darkModeToggle">
                                        Dark Mode
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-center justify-content-end">
                                <div class="form-check form-switch">
                                    <label class="form-check-label mr-3" for="lightToggle">
                                        Lights
                                    </label>
                                    <input class="form-check-input" type="checkbox" id="lightToggle" checked>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Door Control-->
                <div class="card border-primary col-12">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Door Control</h5>
                                        <div class="form-check form-switch mt-2">
                                            <h6>Door Status</h6>
                                            <input class="form-check-input" type="checkbox" id="door-toggle">
                                            <label class="form-check-label" for="door-toggle">Door</label>
                                        </div>
                                        <span id="doorStatusText">Closed</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Fan and Heat Control -->
                <div class="card border-primary col-12">
                    <div class="card-body">
                        <div class="row">
                            <!-- Fan Control -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Fan Control</h5>
                                        <div>
                                            <h6>Fan Speed</h6>
                                            <input type="range" class="form-range" id="fanSpeedRange" min="0" max="3" value="0">
                                            <span id="fanSpeedValue">0</span>
                                            <div class="form-check form-switch mt-2">
                                                <input class="form-check-input" type="checkbox" id="fanToggle">
                                                <label class="form-check-label" for="fanToggle" checked>
                                                    Fan
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Heat Control -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Heat Control</h5>
                                        <div>
                                            <h6>Heat Level</h6>
                                            <input type="range" class="form-range" id="heatLevelRange" min="50" max="90">
                                            <span id="heatLevelValue"></span>
                                            <div class="form-check form-switch mt-2">
                                                <input class="form-check-input" type="checkbox" id="heatToggle">
                                                <label class="form-check-label" for="heatToggle" checked>
                                                    Heat
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Dashboard -->
        <div class="col-12 pb-5 g-lg-3" style="display:none" id="divDashboard">
            <div class="d-flex flex-column flex-lg-row align-items-start">
                <!-- Observations -->
                <div class="card border-primary col-12 col-sm me-lg-3">
                    <div class="card-header bg-primary">
                        <h3 class="text-center text-light">Observations</h3>
                    </div>
                    <div class="card-body">
                        <!-- Above Table/Graph-->
                        <div class="d-flex align-items-start mb-3">
                            <div class="col me-3">
                                <button type="button" id="btnFill" class="btn btn-primary mb-3">Fill With Current
                                    Data</button>
                                <div class="d-flex flex-column mb-2">
                                    <label class="pb-2" for="numTemp">Temperature (F)</label>
                                    <input class="rounded-2 w-50" id="numTemp" type="number"
                                        oninput="this.value = Math.round(this.value)">
                                </div>
                                <div class="d-flex flex-column mb-4">
                                    <label class="pb-2" for="numHumidity">Humidity %</label>
                                    <input class="rounded-2 w-50" id="numHumidity" type="number"
                                        oninput="this.value = Math.round(this.value)">
                                </div>
                            </div>
                            <!-- Weather -->
                            <div class="card border-primary">
                                <div class="card-header bg-primary">
                                    <h3 class="text-center text-light">Current<br>Weather</h3>
                                </div>
                                <div class="card-body d-flex">
                                    <div class="d-sm-block d-none my-auto">
                                        <p class="h5" id="txtHigh"></p>
                                        <p class="m-0" id="txtLow"></p>
                                    </div>
                                    <div class="d-flex">
                                        <hr class="vr mx-3 d-sm-block d-none">
                                        </hr>
                                        <div>
                                            <div class="mb-2">
                                                <p class="m-0" id="txtLocation"></p>
                                                <p class="small fw-light" id="txtDay"></p>
                                            </div>
                                            <p class="m-0 h3" id="txtTemp"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <button type="button" id="btnLogObservation" class="btn btn-primary">Log
                                Observation</button>
                            <button type="button" id="btnObservationsGraph" class="btn btn-primary">View Graph</button>
                            <button type="button" id="btnObservationsTable" class="btn btn-primary"
                                style="display: none">View Table</button>
                        </div>
                        <!-- Table -->
                        <div id="divObservationsTable">
                            <table id="tblObservations" class="table table-striped">
                                <thead>
                                    <tr>
                                        <th class="text-center">Date <span
                                                class="d-none d-sm-inline">(YYYY-MM-DD)</span></th>
                                        <th class="text-center">Temp<span class="d-none d-sm-inline">erature</span> (째F)
                                        </th>
                                        <th class="text-center">Humidity %</th>
                                    </tr>
                                </thead>
                                <tbody id="tblObservationsBody">
                                    <!-- Observation data will be here-->
                                </tbody>
                            </table>
                        </div>
                        <!-- Graph -->
                        <div style="display: none" id="divObservationsGraph">
                            <canvas id="grfObservations"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Eggs -->
                <div class="card border-primary col-12 col-sm ms-lg-3 mt-5 mt-lg-0">
                    <div class="card-header bg-primary">
                        <h3 class="text-center text-light">Egg Counter</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-sm-row flex-column justify-content-between align-items-center mb-3">
                            <div class="input-group col justify-content-sm-start justify-content-center mb-sm-0 mb-3">
                                <input class="rounded-start col-4" id="numEggs" type="number"
                                    aria-label="Number of eggs to log">
                                <button type="button" id="btnEggs" class="btn btn-primary">Log Eggs</button>
                            </div>
                            <button type="button" id="btnEggsGraph" class="btn btn-primary">View Graph</button>
                            <button type="button" id="btnEggsTable" class="btn btn-primary" style="display: none">View
                                Table</button>
                        </div>
                        <!-- Table -->
                        <div id="divEggsTable">
                            <table id="tblEggs" class="table table-striped">
                                <thead>
                                    <tr>
                                        <th class="text-center">Date <span
                                                class="d-none d-sm-inline">(YYYY-MM-DD)</span></th>
                                        <th class="text-center">Count</th>
                                    </tr>
                                </thead>
                                <tbody id="tblEggsBody">
                                    <!-- Egg data will be here-->
                                </tbody>
                            </table>
                        </div>
                        <!-- Graph -->
                        <div style="display:none" id="divEggsGraph">
                            <canvas id="grfEggs"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.datatables.net/2.0.1/js/dataTables.min.js"></script>
    <script lang="text/javascript">

        // Global Variables
        let strLat = "";
        let strLon = "";
        let tblObservations = $('#tblObservations').DataTable({ autoWidth: false });
        let tblEggs = $('#tblEggs').DataTable({ autoWidth: false });
        let grfObservations;
        let grfEggs;
        let fanSpeed = 0;
        let heatLevelRangeValue;

        // For Testing Purposes
        // deleteUser('');
        function deleteUser(strEmail) {
            $.ajax({
                type: 'DELETE',
                url: "http://www.simplecoop.swollenhippo.com/users.php",
                data: {
                    Email: strEmail
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {
                    result = JSON.parse(result);
                    console.log(result);

                    $.ajax({
                        type: 'DELETE',
                        url: "http://www.simplecoop.swollenhippo.com/useraddress.php",
                        data: {
                            Email: strEmail
                        },
                        error: function (e) {
                            console.log(e);
                        },
                        success: function (result) {
                            result = JSON.parse(result);
                            console.log(result);
                        }
                    })
                }
            });
        }

        // For Testing Purposes
        // deleteObservation('');
        function deleteObservation(strLogID) {
            $.ajax({
                type: 'DELETE',
                url: "http://www.simplecoop.swollenhippo.com/environment.php",
                data: {
                    SessionID: sessionStorage.getItem('SessionID'),
                    logID: strLogID
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {
                    result = JSON.parse(result);
                    console.log(result);
                }
            });
        }

        // Updates Session's LastUsedDateTime
        function updateSession() {
            $.ajax({
                type: 'PUT',
                url: "http://www.simplecoop.swollenhippo.com/sessions.php",
                data: { SessionID: sessionStorage.getItem("SessionID") },
                error: function (e) {
                    console.log(e);
                },
            });
        }

        // Formats a date object to a string in the format YYYY-MM-DD HH:MM AM/PM
        function formatDate(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();

            let hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';

            hours = hours % 12;
            hours = hours ? hours : 12;

            const paddedMonth = month < 10 ? '0' + month : month;
            const paddedDay = day < 10 ? '0' + day : day;
            const paddedHours = hours < 10 ? '0' + hours : hours;
            const paddedMinutes = minutes < 10 ? '0' + minutes : minutes;

            return `${year}-${paddedMonth}-${paddedDay} ${paddedHours}:${paddedMinutes} ${ampm}`;
        }

        // Converts a date to ISO format but in local time
        function toLocalISOString(date) {
            const offset = date.getTimezoneOffset() * 60000; // offset in milliseconds
            const localISOTime = (new Date(date - offset)).toISOString().slice(0, -1);
            return localISOTime.replace('Z', '');
        }

        // Returns the current day of the week
        function getCurrentDayOfWeek() {
            const arrDaysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            return arrDaysOfWeek[new Date().getDay()];
        }

        // Gets user's latitude and longitude based on their ZIP code and fills weather widget
        function getWeather(strEmail) {
            $.ajax({
                type: 'GET',
                url: "http://www.simplecoop.swollenhippo.com/useraddress.php",
                data: {
                    Email: strEmail
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {
                    result = JSON.parse(result);
                    console.log("User Address", result);
                    $('#txtLocation').text(result.City);

                    $.ajax({
                        type: 'GET',
                        url: `http://api.openweathermap.org/geo/1.0/zip?zip=${result.ZIP},US&appid=5e8668fb13050ff3f6df16196b1f5be3`,
                        error: function (e) {
                            console.log(e);
                        },
                        success: function (result) {
                            console.log("Lat/Lon", result);
                            strLat = result.lat;
                            strLon = result.lon;

                            $.ajax({
                                type: 'GET',
                                url: `https://api.openweathermap.org/data/3.0/onecall?lat=${strLat}&lon=${strLon}&exclude=minutely,hourly,alerts&units=imperial&appid=5e8668fb13050ff3f6df16196b1f5be3`,
                                error: function (e) {
                                    console.log(e);
                                },
                                success: function (result) {
                                    console.log("Weather API", result);
                                    $('#txtTemp').text(Math.round(result.current.temp) + "째F");
                                    $('#txtHigh').text(Math.round(result.daily[0].temp.max) + "째F");
                                    $('#txtLow').text(Math.round(result.daily[0].temp.min) + "째F");

                                    // Set the current temperature as the default value for the range input
                                    heatLevelRangeValue = Math.round(result.current.temp);
                                    $('#heatLevelRange').val(Math.round(result.current.temp));
                                    // Set the initial display value in the span element
                                    $('#heatLevelValue').text(Math.round(result.current.temp));
                                }
                            });
                        }

                    })
                }
            });
        }

        // Gets colormode from the database and changes the theme accordingly
        function getSettings() {
            if (!sessionStorage.getItem("SessionID")) {
                console.log("SessionID invalid or does not exist, settings could not be found.");
                return;
            }

            $.ajax({
                type: 'GET',
                url: "http://www.simplecoop.swollenhippo.com/settings.php",
                data: {
                    SessionID: sessionStorage.getItem("SessionID"),
                    setting: 'colormode'
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {
                    result = JSON.parse(result);
                    console.log("ColorMode", result);

                    if (result != null) {
                        let strMode = result.Value;
                        if (strMode == 'dark') {
                            $('html').attr('data-bs-theme', 'dark');
                            $("#btnColorMode").attr('aria-label', 'Toggle Light Mode');
                            localStorage.setItem('colormode', 'dark');
                            $(".fa-moon").hide();
                            $(".fa-sun").show();
                        } else {
                            $('html').attr('data-bs-theme', 'light');
                            $("#btnColorMode").attr('aria-label', 'Toggle Dark Mode');
                            localStorage.setItem('colormode', 'light');
                            $(".fa-moon").show();
                            $(".fa-sun").hide();
                        }
                    }
                }
            });
        }

        // Updates color mode in the database
        function setColorMode(strMode) {
            if (strMode != 'light' && strMode != 'dark') {
                console.log("Invalid color mode string");
                return;
            }

            if (sessionStorage.getItem('SessionID')) {
                $.ajax({
                    type: 'DELETE',
                    url: "http://www.simplecoop.swollenhippo.com/settings.php",
                    data: {
                        SessionID: sessionStorage.getItem('SessionID'),
                        setting: 'colormode'
                    },
                    error: function (e) {
                        console.log(e);
                    },
                    success: function (result) {
                        result = JSON.parse(result);
                        console.log(result);

                        $.ajax({
                            type: 'POST',
                            url: "http://www.simplecoop.swollenhippo.com/settings.php",
                            data: {
                                SessionID: sessionStorage.getItem('SessionID'),
                                setting: "colormode",
                                value: strMode
                            },
                            error: function (e) {
                                console.log(e);
                            },
                            success: function (result) {
                                result = JSON.parse(result);
                                console.log(result);

                                localStorage.setItem('colormode', strMode);
                                $("#btnColorMode").prop('disabled', false);
                            }
                        });
                    }
                });
            } else {
                localStorage.setItem('colormode', strMode);
                $("#btnColorMode").prop('disabled', false);
            }
        }

        // Populates environment observations table and graph
        function getEnvironmentObservations() {
            $.ajax({
                type: 'GET',
                url: "http://www.simplecoop.swollenhippo.com/environment.php",
                data: {
                    SessionID: sessionStorage.getItem('SessionID'),
                    days: 100000
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {
                    result = JSON.parse(result);
                    console.log("Environment Observations", result);

                    let arrObservationDates = [];
                    let arrTemperatures = [];
                    let arrHumidities = [];

                    result.forEach(log => {
                        tblObservations.row.add([
                            formatDate(new Date(log.ObservationDateTime.replace(' ', 'T'))),
                            log.Temperature,
                            log.Humidity
                        ]).draw();

                        arrObservationDates.push(formatDate(new Date(log.ObservationDateTime)).slice(0, 10));
                        arrTemperatures.push(log.Temperature);
                        arrHumidities.push(log.Humidity);
                    });

                    var ctx = document.getElementById('grfObservations').getContext('2d');
                    grfObservations = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: arrObservationDates,
                            datasets: [{
                                label: 'Temperature (F)',
                                data: arrTemperatures,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }, {
                                label: 'Humidity (%)',
                                data: arrHumidities,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    ticks: {
                                        callback: function (value) {
                                            if (value % 1 === 0) {
                                                return value;
                                            }
                                        }
                                    }
                                },
                                x: {
                                    ticks: {
                                        autoskip: true,
                                        maxTicksLimit: 5
                                    }
                                }
                            }
                        }
                    });
                }
            });
        }

        // Populates egg table and graph
        function getEggs() {
            $.ajax({
                type: 'GET',
                url: "http://www.simplecoop.swollenhippo.com/eggs.php",
                data: {
                    SessionID: sessionStorage.getItem('SessionID'),
                    days: 100000
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {
                    result = JSON.parse(result);
                    console.log("Egg Logs", result);

                    let arrLogDates = [];
                    let arrEggCounts = [];

                    result.forEach(log => {
                        tblEggs.row.add([
                            formatDate(new Date(log.LogDateTime.replace(' ', 'T'))),
                            log.Harvested
                        ]).draw(false);

                        arrLogDates.push(formatDate(new Date(log.LogDateTime)).slice(0, 10));
                        arrEggCounts.push(log.Harvested);
                    });

                    var ctx = document.getElementById('grfEggs').getContext('2d');
                    grfEggs = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: arrLogDates,
                            datasets: [{
                                label: 'Egg Count',
                                data: arrEggCounts,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    ticks: {
                                        // Use a callback function to format ticks as whole numbers
                                        callback: function (value) {
                                            if (value % 1 === 0) {
                                                return value;
                                            }
                                        }
                                    }
                                },
                                x: {
                                    ticks: {
                                        autoskip: true,
                                        maxTicksLimit: 5
                                    }
                                }
                            }
                        }
                    });
                }
            });

        }

        $(document).ready(function () {
            $('#txtDay').text(getCurrentDayOfWeek());
            // Checks if there is anything in sessionStorage
            if (sessionStorage.getItem("SessionID")) {
                $.getJSON("http://www.simplecoop.swollenhippo.com/sessions.php", { SessionID: sessionStorage.getItem("SessionID") }, function (result) {
                    if (result.SessionID != sessionStorage.getItem("SessionID")) {
                        sessionStorage.removeItem("SessionID");
                    }

                    let strEmail = result.Email;

                    if (!strEmail) {
                        console.log("Could not find user email from session ID");
                        $("#divLogin").slideToggle();
                        return;
                    }

                    if (sessionStorage.getItem("SessionID")) {
                        updateSession();
                        getWeather(strEmail);
                        getSettings();
                        getEggs();
                        getEnvironmentObservations();

                        $('#btnLogout').show();
                        $("#divDashboard").slideToggle();
                    } else {
                        console.log("Invalid SessionID. Displaying Login")
                        $("#divLogin").slideToggle();
                        if (localStorage.getItem('colormode') == 'dark') {
                            $("#btnColorMode").attr('aria-label', 'Toggle Light Mode');
                            $(".fa-moon").hide();
                            $(".fa-sun").show();
                        }
                    }
                });
            } else {
                console.log("No session ID found. Displaying Login")
                $("#divLogin").slideToggle();
                if (localStorage.getItem('colormode') == 'dark') {
                    $("#btnColorMode").attr('aria-label', 'Toggle Light Mode');
                    $(".fa-moon").hide();
                    $(".fa-sun").show();
                }
            }
        });

        // Toggles login and register cards using the jQuery "is visible" tool
        $('.btnToggle').on('click', function () {
            if ($('#divLogin').is(':visible')) {
                console.log("Toggling to Register")
                $('#divLogin').slideToggle(function () {
                    $('#divRegister').slideToggle();
                });
            }
            else {
                console.log("Toggling to Login")
                $('#divRegister').slideToggle(function () {
                    $('#divLogin').slideToggle();
                });
            }
        });

        // Logout button functionality
        $('#btnLogout').on('click', function () {
            $.ajax({
                url: 'http://www.thesimplehomestead.com/simpletime/sessions.php',
                type: 'DELETE',
                data: { SessionID: sessionStorage.getItem('SessionID') },
                success: function (result) {
                    result = JSON.parse(result);
                    console.log(result);
                    sessionStorage.removeItem('SessionID');

                    tblObservations.clear().draw();
                    tblEggs.clear().draw();
                    grfObservations.destroy();
                    grfEggs.destroy();

                    $('#divDashboard').slideUp(function () {
                        $('#btnLogout').hide();
                        $('#divLogin').slideDown();
                    })
                }
            });
        })

        // Login button functionality
        $('#btnLogin').on('click', function () {
            let strEmail = $('#txtLoginEmail').val();
            let strPassword = $('#txtLoginPassword').val();

            $.post("http://www.simplecoop.swollenhippo.com/sessions.php", { Email: strEmail, Password: strPassword }, function (result) {
                result = JSON.parse(result);

                if (result.Outcome != undefined) {
                    Swal.fire({
                        title: "Oops!",
                        html: "<p>Invalid email or password!</p>",
                        icon: "error",
                    });

                    return;
                }
                sessionStorage.setItem("SessionID", result.SessionID);

                getWeather(strEmail);
                getSettings();
                getEggs();
                getEnvironmentObservations();

                $('#txtLoginEmail').val('');
                $('#txtLoginPassword').val('');
                $('#divLogin').slideToggle(function () {
                    $('#btnLogout').show();
                    $('#divDashboard').slideToggle();
                });

            })
        });

        // Register button functionality
        $('#btnRegister').on('click', function () {
            let strFirstName = $('#txtFirstName').val();
            let strLastName = $('#txtLastName').val();
            let strEmail = $('#txtRegisterEmail').val();
            let strPassword = $('#txtRegisterPassword').val();
            let strStreetAddress1 = $('#txtStreetAddress1').val();
            let strStreetAddress2 = $('#txtStreetAddress2').val();
            let strCity = $('#txtCity').val();
            let strState = $('#txtState').val();
            let strZip = $('#txtZip').val();
            let strPhone = $('#txtPhone').val();
            let strCoopID = $('#txtCoopID').val();

            let blnError = false;
            let strErrorMessage = "";

            let regexEmail = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/g;
            if (!regexEmail.exec(strEmail)) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Email.</p>";
            }

            let regexPassword = /^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*\W)(?!.* ).{8,16}$/;
            if (!regexPassword.exec(strPassword)) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Password must be 8-16 characters, including a lowercase and uppercase letter, a number, and a special character.</p>";
            }

            if (strFirstName.length < 2) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid First Name.</p>";
            }

            if (strLastName.length < 2) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Last Name.</p>";
            }

            if (strStreetAddress1.length < 5) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Street Address.</p>";
            }

            // none for address 2, that is allowed to be blank

            if (strCity.length < 2) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid City.</p>";
            }

            if (strState.length < 2) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid State.</p>";
            }

            let regexZip = /\d{5}([ \-]\d{4})?/;
            if (!regexZip.exec(strZip)) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid ZIP Code.</p>";
            }

            let regexPhoneNum = /^\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$/;
            if (!regexPhoneNum.exec(strPhone)) {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Invalid Phone Number.</p>";
            }

            // Assuming IDs are length 8, may change later!
            if (strCoopID !== 'PTEYA3J6') {
                blnError = true;
                strErrorMessage = strErrorMessage + "<p>Coop ID should be PTEYA3J6</p>";
            }

            if (blnError == true) {
                console.log(strErrorMessage);
                Swal.fire({
                    title: "Oops!",
                    html: strErrorMessage,
                    icon: "error",
                });
            } else {
                $.getJSON("http://simplecoop.swollenhippo.com/users.php", { Email: strEmail }, function (result) {
                    if (result != null) {
                        Swal.fire({
                            title: "Oops!",
                            html: "<p>Account with that email already exists.</p>",
                            icon: "error",
                        });

                        return;
                    }

                    $.post(
                        "http://simplecoop.swollenhippo.com/users.php",
                        {
                            Email: strEmail,
                            Password: strPassword,
                            FirstName: strFirstName,
                            LastName: strLastName,
                            CoopID: strCoopID,
                        },
                        function (result) {
                            result = JSON.parse(result);

                            if (result.Error) {
                                Swal.fire({
                                    title: "Oops!",
                                    html: "<p>" + result.Error + "</p>",
                                    icon: "error",
                                });
                            }
                        }
                    )

                    $.post(
                        "http://simplecoop.swollenhippo.com/useraddress.php",
                        {
                            Email: strEmail,
                            Street1: strStreetAddress1,
                            Street2: strStreetAddress2,
                            City: strCity,
                            State: strState,
                            ZIP: strZip,
                        },
                        function (result) {
                            result = JSON.parse(result);

                            if (result.Error) {
                                Swal.fire({
                                    title: "Oops!",
                                    html: "<p>" + result.Error + "</p>",
                                    icon: "error",
                                });
                            }
                        }
                    )

                    $.post("http://www.simplecoop.swollenhippo.com/sessions.php", { Email: strEmail, Password: strPassword }, function (result) {
                        result = JSON.parse(result);

                        if (result.Outcome != undefined) {
                            Swal.fire({
                                title: "Oops!",
                                html: "<p>There was an issue while loggin you in, please try again!</p>",
                                icon: "error",
                            });

                            return;
                        }

                        $('#txtFirstName').val('');
                        $('#txtLastName').val('');
                        $('#txtRegisterEmail').val('');
                        $('#txtRegisterPassword').val('');
                        $('#txtStreetAddress1').val('');
                        $('#txtStreetAddress2').val('');
                        $('#txtCity').val('');
                        $('#txtState').val('');
                        $('#txtZip').val('');
                        $('#txtPhone').val('');
                        $('#txtCoopID').val('');

                        sessionStorage.setItem("SessionID", result.SessionID);
                        setColorMode($('html').attr('data-bs-theme'));

                        getWeather(strEmail);
                        getEggs();
                        getEnvironmentObservations();

                        $('#divRegister').slideToggle(function () {
                            $('#btnLogout').show();
                            $('#divDashboard').slideToggle();
                        });
                    })
                })
            }
        });

        // Dark mode toggle
        $('#btnColorMode').on('click', function () {
            $("#btnColorMode").prop('disabled', true);
            let strMode = $('html').attr('data-bs-theme');
            if (strMode == 'light') {
                $('html').attr('data-bs-theme', 'dark');
                $("#btnColorMode").attr('aria-label', 'Toggle Light Mode');
                $(".fa-moon").hide();
                $(".fa-sun").show();
                strMode = 'dark';
            } else {
                $('html').attr('data-bs-theme', 'light');
                $("#btnColorMode").attr('aria-label', 'Toggle Dark Mode');
                $(".fa-moon").show();
                $(".fa-sun").hide();
                strMode = 'light';
            }

            setColorMode(strMode);
        });

        // Fill observation inputs with current data from weather API
        $('#btnFill').on('click', function () {
            updateSession();
            $.ajax({
                type: 'GET',
                url: `https://api.openweathermap.org/data/3.0/onecall?lat=${strLat}&lon=${strLon}&exclude=minutely,hourly,daily,alerts&units=imperial&appid=5e8668fb13050ff3f6df16196b1f5be3`,
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {
                    console.log("Current Weather", result);
                    $('#numTemp').val(Math.round(result.current.temp));
                    $('#numHumidity').val(Math.round(result.current.humidity));
                }
            });
        });

        // Log observation
        $('#btnLogObservation').on('click', function () {
            updateSession();
            let strTemp = $('#numTemp').val();
            let strHumidity = $('#numHumidity').val();
            let dtCurrentDate = new Date();

            $.ajax({
                type: 'POST',
                url: "http://www.simplecoop.swollenhippo.com/environment.php",
                data: {
                    SessionID: sessionStorage.getItem('SessionID'),
                    temperature: strTemp,
                    observationDateTime: toLocalISOString(dtCurrentDate),
                    humidity: strHumidity
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {
                    result = JSON.parse(result);
                    console.log(result);

                    strCurrentDate = formatDate(dtCurrentDate);
                    tblObservations.row.add([
                        strCurrentDate,
                        strTemp,
                        strHumidity
                    ]).draw();

                    grfObservations.data.labels.push(strCurrentDate.slice(0, 10));
                    grfObservations.data.datasets[0].data.push(strTemp);
                    grfObservations.data.datasets[1].data.push(strHumidity);
                    grfObservations.update();
                }
            });
        });

        // Switch to observations graph view
        $('#btnObservationsGraph').on('click', function () {
            console.log("Swapping to Observations Graph");
            updateSession();
            $('#divObservationsGraph').show();
            $('#divObservationsTable').hide();
            $('#btnObservationsGraph').hide();
            $('#btnObservationsTable').show();
        });

        // Switch to observations table view
        $('#btnObservationsTable').on('click', function () {
            console.log("Swapping to Observations Table");
            updateSession();
            $('#divObservationsTable').show();
            $('#divObservationsGraph').hide();
            $('#btnObservationsTable').hide();
            $('#btnObservationsGraph').show();
        });

        // Log eggs
        $('#btnEggs').on('click', function () {
            updateSession();
            let intEggs = $('#numEggs').val();
            let dtCurrentDate = new Date();
            $.ajax({
                type: 'POST',
                url: "http://www.simplecoop.swollenhippo.com/eggs.php",
                data: {
                    SessionID: sessionStorage.getItem('SessionID'),
                    eggs: intEggs,
                    observationDateTime: toLocalISOString(dtCurrentDate)
                },
                error: function (e) {
                    console.log(e);
                },
                success: function (result) {
                    result = JSON.parse(result);
                    console.log(result);

                    strCurrentDate = formatDate(dtCurrentDate);
                    tblEggs.row.add([
                        strCurrentDate,
                        intEggs
                    ]).draw();

                    grfEggs.data.labels.push(strCurrentDate.slice(0, 10));
                    grfEggs.data.datasets[0].data.push(intEggs);
                    grfEggs.update();
                }
            });
        });

        // Switch to eggs graph view
        $('#btnEggsGraph').on('click', function () {
            console.log("Swapping to Eggs Graph");
            updateSession();
            $('#divEggsGraph').show();
            $('#divEggsTable').hide();
            $('#btnEggsGraph').hide();
            $('#btnEggsTable').show();
        });

        // Switch to eggs table view
        $('#btnEggsTable').on('click', function () {
            console.log("Swapping to Eggs Table");
            updateSession();
            $('#divEggsTable').show();
            $('#divEggsGraph').hide();
            $('#btnEggsTable').hide();
            $('#btnEggsGraph').show();
        });

        $('#btnOpenSettings').on('click', function () {
        $('#settingsDashboard').show();
        $('#divDashboard').hide();

    });

    // Function to open settings dashboard
    $('#btnOpenSettings').on('click', function () {
        $('#settingsDashboard').show();
        $('#divDashboard').hide();
    });

    // Function to close settings dashboard
    $('#btnCloseSettings').on('click', function () {
        $('#settingsDashboard').hide();
        $('#divDashboard').show();
    });

    // Function to handle dark mode toggle
    $('#darkModeToggle').on('change', function () {
        let darkModeEnabled = $(this).prop('checked');
        if (darkModeEnabled) {
            enableDarkMode();
        } else {
            disableDarkMode();
        }
    });

    // Function to enable dark mode
    function enableDarkMode() {
        $('html').attr('data-bs-theme', 'dark');
    }

    // Function to disable dark mode
    function disableDarkMode() {
        $('html').attr('data-bs-theme', 'light');
    }

    // Function to handle fan toggle
    $('#fanToggle').on('change', function () {
        let fanEnabled = $(this).prop('checked');
        if (fanEnabled) {
            console.log('Fan turned on');
        } else {
            console.log('Fan turned off');
        }
    });

    // Event listener for input on heat level range
    $('#heatLevelRange').on('input', function () {
        heatLevelValue = parseFloat($(this).val());
        updateHeatControl();
    });

    // Function to handle heat toggle
    function updateHeatControl() {
        const heatToggle = document.getElementById('heatToggle');
        if (heatLevelValue > heatLevelRangeValue) {
            heatToggle.checked = false;
            console.log('Heat turned off');
        } else {
            heatToggle.checked = true;
            console.log('Heat turned on');
        }
    }

        // Function to handle light toggle
        $('#lightToggle').on('change', function () {
            let lightEnabled = $(this).prop('checked');
            if (lightEnabled) {
                console.log('Lights turned on');
            } else {
                console.log('Lights turned off');
            }
        });

    // Event listener for fan speed range input
    document.getElementById("fanSpeedRange").addEventListener("input", function() {
        document.getElementById("fanSpeedValue").textContent = this.value;
        var fanToggle = document.getElementById("fanToggle");

        if (parseInt(this.value) > 0) {
            fanToggle.checked = true;
        } else {
            fanToggle.checked = false;
        }
    });

    // Event listener for fan toggle checkbox
    document.getElementById("fanToggle").addEventListener("change", function() {
        var fanSpeedRange = document.getElementById("fanSpeedRange");
        if (!this.checked) {
            fanSpeedRange.value = 0;
            document.getElementById("fanSpeedValue").textContent = 0;
        }
    });

    // Event listener for heat level range input
    document.getElementById("heatLevelRange").addEventListener("input", function() {
        document.getElementById("heatLevelValue").textContent = this.value;
    });


    // Event listener for decreasing fan speed
    $('#btnDecreaseFanSpeed').on('click', function () {
        if (fanSpeed > 0) {
            fanSpeed--;
            updateFanSpeedDisplay();
        }

    });

    // Event listener for increasing fan speed
    $('#btnIncreaseFanSpeed').on('click', function () {
        if (fanSpeed < 3) {
            fanSpeed++;
            updateFanSpeedDisplay();
        }
    });

    // Event listener for fan toggle
    $('#btnFanToggle').on('click', function () {
        let fanState = $(this).text();
        if (fanState === 'Turn On') {
            $(this).text('Turn Off');

        } else {
            $(this).text('Turn On');
        }
    });

    // Updates the state of the door
    function updateDoorStatusDisplay(doorState) {
        $("#doorStatusText").text(doorState); // Assuming you have an element with id "doorStatusText"
    };

    // Door Functionality
    $('#door-toggle').on('change', function() {
        let doorState;
        if ($(this).prop('checked')) {
            doorState = "Open";
        } else {
            doorState = "Closed";
        }

        updateSettings(sessionStorage.getItem('SessionID'), 'door_status', doorState, 'PUT');
        updateDoorStatusDisplay(doorState);
    });

    // Function to update settings
    function updateSettings(sessionID, setting, value, method) {
        $.ajax({
            type: method,
            url: "http://www.simplecoop.swollenhippo.com/settings.php",
            data: {
                SessionID: sessionStorage.getItem('SessionID'),
                setting: setting,
                value: value
            },
            error: function (e) {
                console.log(e);
            },
            success: function (result) {
                result = JSON.parse(result);
                console.log(result);
            }
        });
    }
    </script>
</body>

</html>